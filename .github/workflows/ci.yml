name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: {}

env:
  REGISTRY: ghcr.io
  API_IMAGE: ghcr.io/${{ github.repository }}/api
  CLIENT_IMAGE: ghcr.io/${{ github.repository }}/client

jobs:
  lint-api:
    name: Lint API
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node
        uses: ./.github/actions
        with:
          working-directory: api

      - name: Lint
        working-directory: api
        run: npm run lint

  lint-client:
    name: Lint Client
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node
        uses: ./.github/actions
        with:
          working-directory: client

      - name: Lint
        working-directory: client
        run: npm run lint

  test-api:
    name: Test API
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:18.1
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node
        uses: ./.github/actions
        with:
          working-directory: api

      - name: Run tests
        working-directory: api
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: test
          DB_PASSWORD: test
          DB_NAME: test
        run: npm test -- --ci --coverage --maxWorkers=2

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          flags: api
          fail_ci_if_error: false

  test-client:
    name: Test Client
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node
        uses: ./.github/actions
        with:
          working-directory: client

      - name: Run tests
        working-directory: client
        run: npm test -- --ci --coverage --maxWorkers=2

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          flags: client
          fail_ci_if_error: false

  audit:
    name: Security Audit
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Audit API
        working-directory: api
        run: npm audit --audit-level=high

      - name: Audit Client
        working-directory: client
        run: npm audit --audit-level=high

  build-api:
    name: Build API Image
    runs-on: ubuntu-24.04
    needs: [lint-api, test-api]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tag: sha-${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ./api
          file: ./api/Dockerfile
          target: runtime
          push: true
          tags: ${{ env.API_IMAGE }}:sha-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,scope=api,mode=max

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign image
        run: cosign sign --yes ${{ env.API_IMAGE }}@${{ steps.build.outputs.digest }}

      - name: Attest provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-name: ${{ env.API_IMAGE }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  build-client:
    name: Build Client Image
    runs-on: ubuntu-24.04
    needs: [lint-client, test-client]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tag: sha-${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ./client
          file: ./client/Dockerfile
          target: runtime
          push: true
          tags: ${{ env.CLIENT_IMAGE }}:sha-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha,scope=client
          cache-to: type=gha,scope=client,mode=max

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign image
        run: cosign sign --yes ${{ env.CLIENT_IMAGE }}@${{ steps.build.outputs.digest }}

      - name: Attest provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-name: ${{ env.CLIENT_IMAGE }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  scan-images:
    name: Scan Images
    runs-on: ubuntu-24.04
    needs: [build-api, build-client]
    permissions:
      contents: read
      packages: read
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan API image
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: ${{ env.API_IMAGE }}@${{ needs.build-api.outputs.digest }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: "1"

      - name: Scan Client image
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: ${{ env.CLIENT_IMAGE }}@${{ needs.build-client.outputs.digest }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: "1"

  deploy-staging:
    name: Deploy Staging
    needs: [build-api, build-client, scan-images]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: staging
      api-tag: sha-${{ github.sha }}
      client-tag: sha-${{ github.sha }}
    secrets: inherit
