# -- Content Security Policy --
#
# style-src 'unsafe-inline': Required by DHIS2 UI. Every DHIS2 UI component
# uses styled-jsx, which injects CSS via document.createElement('style') and
# CSSStyleSheet.insertRule(). Both require 'unsafe-inline' in style-src.
# styled-jsx supports CSP nonces (reads from <meta property="csp-nonce">),
# but nonces require per-request generation — not possible with static nginx.
# To eliminate 'unsafe-inline', the serving layer would need to move to a
# dynamic server or an nginx module like ngx_set_misc + sub_filter.
#
# Risk is bounded: script-src has NO unsafe-inline/eval, so injected CSS
# cannot escalate to script execution. CSS injection is limited to cosmetic
# attacks and data exfiltration via attribute selectors + url() — mitigated
# by connect-src 'self' blocking arbitrary outbound requests.
add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'none'; frame-ancestors 'none'; worker-src 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests" always;

add_header X-Content-Type-Options           "nosniff" always;
add_header X-Frame-Options                  "DENY" always;
add_header Referrer-Policy                  "strict-origin-when-cross-origin" always;
add_header Cross-Origin-Opener-Policy       "same-origin" always;
add_header Cross-Origin-Resource-Policy     "same-origin" always;
add_header X-Permitted-Cross-Domain-Policies "none" always;
add_header Permissions-Policy               "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), display-capture=()" always;

# HSTS: Set by Traefik at the TLS termination point, not duplicated here.
#
# Cross-Origin-Embedder-Policy: Intentionally omitted. COEP require-corp
# blocks cross-origin resources that lack a CORP header, which can break
# legitimate subresources. This app does not use SharedArrayBuffer or
# high-resolution timers, so cross-origin isolation is not needed.
